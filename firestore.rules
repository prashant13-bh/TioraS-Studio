rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Simplified admin check - allows any authenticated user for now
    // TODO: Add role-based check once user documents have role field
    function isAdmin() {
      return isSignedIn();
    }

    function isResourceOwner() {
      return isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // -------------------------------------------------------------------------
    // User Profiles (/users)
    // -------------------------------------------------------------------------

    match /users/{userId} {
      allow get: if isOwner(userId) || isSignedIn();
      allow list: if isSignedIn(); 
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isSignedIn();
      allow delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Products (/products) - ALLOW ALL AUTHENTICATED WRITES
    // -------------------------------------------------------------------------

    match /products/{productId} {
      // Public read access
      allow read: if true;
      
      // Any authenticated user can write (for testing - tighten later)
      allow create, update, delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Stock Movements (/stockMovements)
    // -------------------------------------------------------------------------

    match /stockMovements/{movementId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Invoices (/invoices)
    // -------------------------------------------------------------------------

    match /invoices/{invoiceId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Addresses (/addresses)
    // -------------------------------------------------------------------------

    match /addresses/{addressId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Orders (/orders)
    // -------------------------------------------------------------------------

    match /orders/{orderId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Designs (/designs)
    // -------------------------------------------------------------------------

    match /designs/{designId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Carts (/carts)
    // -------------------------------------------------------------------------

    match /carts/{cartId} {
      allow read, write: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Wishlists (/wishlists)
    // -------------------------------------------------------------------------

    match /wishlists/{wishlistId} {
      allow read, write: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Reviews (/reviews)
    // -------------------------------------------------------------------------

    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn();
    }

    // -------------------------------------------------------------------------
    // Catch-all for any other collections (for development)
    // -------------------------------------------------------------------------

    match /{document=**} {
      allow read: if true;
      allow write: if isSignedIn();
    }
  }
}
